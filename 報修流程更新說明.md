# 📍 報修功能流程更新說明

## 🔄 更新內容

### 原本流程
1. 選擇報修類型（水電/電梯/公共設施/其他）
2. 輸入地點
3. 輸入問題
4. 上傳照片

### ✨ 新流程
1. **選擇棟別**（A棟/B棟/C棟）← 新增
2. 輸入詳細位置
3. 輸入問題描述
4. 上傳照片

---

## 🎯 具體改動

### 🟢 第一步：點「報修」

用戶輸入「報修」後，Bot 回覆：

```
🔧 社區報修系統

請選擇棟別 👇
```

顯示 Quick Reply 按鈕：
- [A棟]
- [B棟]  
- [C棟]

### 🟢 第二步：選擇棟別

用戶點選棟別後，Bot 確認並要求輸入詳細位置：

```
✅ 棟別：A棟

📍 請輸入詳細位置
例如：3樓走廊、地下室停車場、501室門口

輸入「取消報修」可中止流程
```

### 🟢 第三步：輸入地點

用戶輸入地點後（例：3樓走廊），Bot 確認並要求描述問題：

```
✅ 地點：3樓走廊

📝 請簡單描述問題狀況
例如：水龍頭漏水、電梯門無法關閉

輸入「取消報修」可中止流程
```

### 🟢 第四步：輸入問題

用戶輸入問題後（例：天花板漏水），Bot 要求上傳照片：

```
✅ 問題描述：天花板漏水

📷 請上傳問題照片
（可直接拍照上傳，或輸入「略過」）

輸入「取消報修」可中止流程
```

### 🟢 第五步：上傳照片

**情況 A：用戶上傳照片**
```
✅ 報修已送出
📌 編號：R20260225-001
目前狀態：🟡 待處理

🏢 棟別：A棟
📍 地點：3樓走廊
📝 問題：天花板漏水
📸 已附上照片

管理單位會盡快處理，謝謝您的通報！
```

**情況 B：用戶輸入「略過」**
```
✅ 報修已送出
📌 編號：R20260225-001
目前狀態：🟡 待處理

🏢 棟別：A棟
📍 地點：3樓走廊
📝 問題：天花板漏水

管理單位會盡快處理，謝謝您的通報！
```

---

## 📊 資料表變更

### repair_requests 表
- ❌ 移除：`repair_type` 欄位（報修類型）
- ✅ 新增：`building` 欄位（棟別：A棟、B棟、C棟）

### repair_sessions 表
- ❌ 移除：`repair_type` 欄位
- ✅ 新增：`building` 欄位
- 🔄 修改：`step` 欄位值從 `location` 改為 `building, location, description, photo`

---

## 🔧 部署步驟

### 1️⃣ 更新資料表結構

在 Supabase SQL Editor 執行以下 SQL：

```sql
-- 新增 building 欄位到 repair_requests
ALTER TABLE repair_requests 
ADD COLUMN IF NOT EXISTS building VARCHAR(10);

-- 新增 building 欄位到 repair_sessions
ALTER TABLE repair_sessions 
ADD COLUMN IF NOT EXISTS building VARCHAR(10);

-- (可選) 移除 repair_type 欄位
-- ALTER TABLE repair_requests DROP COLUMN IF EXISTS repair_type;
-- ALTER TABLE repair_sessions DROP COLUMN IF EXISTS repair_type;
```

**注意：** 如果有舊資料，請先評估是否要保留 `repair_type` 欄位，或進行資料遷移。

### 2️⃣ 重新執行完整的 SQL 檔案（建議）

為確保一致性，建議刪除舊表並重新執行 `supabase_repair_tables.sql`：

```sql
-- ⚠️ 警告：這會刪除所有報修資料
DROP TABLE IF EXISTS repair_status_history CASCADE;
DROP TABLE IF EXISTS repair_sessions CASCADE;
DROP TABLE IF EXISTS repair_requests CASCADE;
DROP TABLE IF EXISTS repair_number_counter CASCADE;

-- 然後執行 supabase_repair_tables.sql 的完整內容
```

### 3️⃣ 部署應用程式

```bash
# 本地測試
npm run dev

# 測試報修流程
# 1. 在 LINE Bot 輸入「報修」
# 2. 選擇棟別
# 3. 輸入地點
# 4. 輸入問題
# 5. 上傳照片或略過

# 部署到 Vercel
vercel --prod
```

---

## 📝 查詢報修記錄的顯示調整

用戶輸入「我的報修」後，顯示格式更新為：

```
📋 您的報修記錄（最近5筆）

1. 編號 R20260225-001
   🟡 待處理
   A棟 - 3樓走廊
   02/25 14:30

2. 編號 R20260224-002
   ✅ 已完成
   B棟 - 地下室停車場
   02/24 09:15

💡 輸入「報修」可開始新的報修
```

---

## 🎨 管理後台調整

管理後台表格欄位更新：

| 報修編號 | 棟別 | 地點 | 問題描述 | 報修人 | 優先級 | 狀態 | 建立時間 | 操作 |
|---------|------|------|---------|--------|--------|------|----------|------|
| R20260225-001 | A棟 | 3樓走廊 | 天花板漏水 | 王小明 | 一般 | 🟡 待處理 | 02/25 14:30 | [更新狀態▼] |

---

## ✅ 測試檢查清單

- [ ] 輸入「報修」顯示棟別選項
- [ ] 選擇棟別後要求輸入地點
- [ ] 輸入地點後要求描述問題
- [ ] 輸入問題後要求上傳照片
- [ ] 上傳照片後完成報修並顯示完整資訊（含棟別）
- [ ] 輸入「略過」可跳過照片上傳
- [ ] 輸入「取消報修」可中止流程
- [ ] 查詢「我的報修」正確顯示棟別資訊
- [ ] 管理後台正確顯示棟別欄位
- [ ] 狀態更新推播正常運作

---

## 🚨 注意事項

1. **資料遷移**：如果有舊的報修記錄，需要處理 `repair_type` 到 `building` 的資料遷移
2. **欄位相容性**：建議保留 `repair_type` 欄位一段時間，確保舊資料可以正常顯示
3. **API 相容性**：更新後的 API 不再需要 `repair_type` 參數，改為 `building`
4. **測試環境**：建議先在測試環境驗證完整流程後再部署到正式環境

---

## 📞 問題排查

### Q1: 舊的報修單沒有棟別資訊怎麼辦？
A: 在查詢和顯示時，加入空值判斷：
```javascript
{repair.building ? repair.building + ' - ' : ''}{repair.location}
```

### Q2: 使用者還能看到舊的報修類型嗎？
A: 可以暫時保留 `repair_type` 欄位，在顯示時優先使用 `building`，若為空則顯示 `repair_type`

### Q3: 如何新增更多棟別選項？
A: 在 [app/api/line/route.js](app/api/line/route.js) 的 Quick Reply 中新增選項：
```javascript
{
  type: 'action',
  action: {
    type: 'message',
    label: 'D棟',
    text: 'building:D棟'
  }
}
```

---

## ✨ 完成！

報修流程已成功更新為：棟別選擇 → 地點輸入 → 問題描述 → 照片上傳

這樣的流程更符合社區管理需求，能更精確地定位報修位置！
