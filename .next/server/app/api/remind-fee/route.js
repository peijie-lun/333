"use strict";(()=>{var e={};e.id=907,e.ids=[907],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},97010:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>_,patchFetch:()=>N,requestAsyncStorage:()=>f,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>c});var s={};t.r(s),t.d(s,{POST:()=>d});var o=t(49303),n=t(88716),i=t(60670),a=t(87070);let u=(0,t(76596).eI)(process.env.SUPABASE_URL,process.env.SUPABASE_ANON_KEY),p=process.env.LINE_CHANNEL_ACCESS_TOKEN;async function d(e){try{let{feeId:r,customMessage:t}=await e.json();if(!r)return a.NextResponse.json({error:"feeId 必填"},{status:400});if(!p)return a.NextResponse.json({error:"缺少 LINE_CHANNEL_ACCESS_TOKEN 環境變數"},{status:500});let{data:s,error:o}=await u.from("fees").select("id, unit_id, amount, due, paid, note").eq("id",r).single();if(o||!s)return console.error("查詢 fees 表失敗:",o),a.NextResponse.json({error:"Fee not found"},{status:404});s.paid?console.log("該費用已繳清，僅執行推播通知"):console.log("費用未繳，準備進行催繳通知");let{data:n,error:i}=await u.from("profiles").select("id, name, unit_id, line_user_id").eq("unit_id",s.unit_id).maybeSingle();if(i)return console.error("查詢 profiles 表失敗:",i),a.NextResponse.json({error:"查詢住戶資料失敗"},{status:500});if(!n?.id)return a.NextResponse.json({error:`未找到單位 ID ${s.unit_id} 的住戶`},{status:404});let d=n.line_user_id;if(!d){let{data:e,error:r}=await u.from("line_users").select("line_user_id").eq("profile_id",n.id).maybeSingle();if(r)return console.error("查詢 line_users 表失敗:",r),a.NextResponse.json({error:"查詢 LINE 綁定失敗"},{status:500});d=e?.line_user_id}if(!d)return a.NextResponse.json({error:"此住戶尚未完成 LINE 綁定"},{status:400});let l=t??`親愛的${n?.name??"住戶"}您好，
您本期的管理費尚未繳清：
金額：${s.amount}
到期日：${s.due}
狀態：${s.paid?"已繳":"未繳"}
${s.note?`備註：${s.note}`:""}
請盡快完成繳費，謝謝！`,f=await fetch("https://api.line.me/v2/bot/message/push",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`},body:JSON.stringify({to:d,messages:[{type:"text",text:l}]})});if(!f.ok){let e=await f.text();return console.error("LINE 推播失敗:",e),a.NextResponse.json({error:"LINE 推播失敗",detail:e},{status:500})}let{error:c}=await u.from("fees").update({updated_at:new Date().toISOString()}).eq("id",s.id);if(c)return console.error("更新 fees 表失敗:",c),a.NextResponse.json({error:"更新費用記錄失敗"},{status:500});return a.NextResponse.json({ok:!0})}catch(e){return console.error("伺服器錯誤:",e),a.NextResponse.json({error:e.message||"伺服器錯誤"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/remind-fee/route",pathname:"/api/remind-fee",filename:"route",bundlePath:"app/api/remind-fee/route"},resolvedPagePath:"C:\\Users\\user\\Desktop\\linebot_03\\333\\app\\api\\remind-fee\\route.js",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:c,serverHooks:m}=l,_="/api/remind-fee/route";function N(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:c})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,370,70],()=>t(97010));module.exports=s})();