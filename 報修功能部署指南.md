# 📍 報修功能 - 完整部署指南

## 🎯 功能概述

完整的社區報修系統，包含：
- ✅ 自動生成報修編號（格式：R20260224-001）
- 🔄 三階段狀態管理（待處理 → 處理中 → 已完成）
- 📱 LINE Bot 互動式報修流程
- 🔔 狀態更新自動推播通知
- 💻 管理者後台管理介面

---

## 📋 部署步驟

### 1️⃣ 建立 Supabase 資料表

在 Supabase 的 SQL Editor 中執行 `supabase_repair_tables.sql` 檔案。

此檔案會自動建立：
- ✅ `repair_requests` - 報修單主表
- ✅ `repair_sessions` - 報修流程 Session
- ✅ `repair_status_history` - 狀態變更記錄
- ✅ `repair_number_counter` - 編號計數器
- ✅ 自動生成報修編號的觸發器
- ✅ 記錄狀態變更歷史的觸發器

```bash
# 執行 SQL 指令
# 在 Supabase Dashboard → SQL Editor 中貼上並執行整個檔案內容
```

### 2️⃣ 環境變數確認

確認 `.env.local` 檔案包含以下變數：

```env
# LINE Bot
LINE_CHANNEL_ACCESS_TOKEN=你的_LINE_Channel_Access_Token
LINE_CHANNEL_SECRET=你的_LINE_Channel_Secret

# Supabase
SUPABASE_URL=你的_Supabase_URL
SUPABASE_ANON_KEY=你的_Supabase_Anon_Key
SUPABASE_SERVICE_ROLE_KEY=你的_Supabase_Service_Role_Key
```

### 3️⃣ 重新部署應用

```bash
# 本地測試
npm run dev

# 部署到 Vercel
vercel --prod
```

---

## 🎮 使用流程

### 🟢 住戶端 - 建立報修

1. **啟動報修**
   - 在 LINE Bot 中輸入「報修」、「我要報修」或「新報修」

2. **選擇類型**
   - 💧 水電問題
   - 🛗 電梯問題
   - 🏊 公共設施
   - 🔨 其他

3. **填寫資訊**
   - 📍 輸入地點（例：3樓電梯、B1停車場）
   - 📝 描述問題（例：水龍頭漏水）
   - 📸 上傳照片（可略過）

4. **送出完成**
   - 系統自動生成報修編號（例：R20260224-001）
   - 收到確認訊息
   - 狀態設為：🟡 待處理

### 🔍 查詢報修記錄

在 LINE Bot 中輸入「我的報修」或「報修記錄」即可查看最近 5 筆報修記錄。

---

## 🟡 管理端 - 處理報修

### 方法一：透過 API 更新

```bash
# 更新報修狀態為「處理中」
curl -X PATCH https://你的網址/api/repairs \
  -H "Content-Type: application/json" \
  -d '{
    "id": 1,
    "status": "processing"
  }'

# 更新為「已完成」
curl -X PATCH https://你的網址/api/repairs \
  -H "Content-Type: application/json" \
  -d '{
    "id": 1,
    "status": "completed"
  }'
```

### 方法二：使用管理後台

1. 訪問 `https://你的網址/repairs`
2. 查看所有報修單列表
3. 使用下拉選單更新狀態
4. 系統自動推播通知給住戶

**後台功能：**
- 📊 篩選報修單（全部/待處理/處理中/已完成）
- 🎯 設定優先級（低/一般/高/緊急）
- ✏️ 更新狀態（待處理/處理中/已完成/已取消）
- 📝 查看完整資訊（編號、類型、地點、描述、照片）

---

## 🔔 自動推播通知

當管理員更新報修狀態時，系統會自動推播 LINE 通知給報修的住戶：

### 🔵 處理中
```
🔔 報修狀態更新

您的報修 R20260224-001
🔵 目前狀態：處理中

我們正在處理您的報修，請稍候。
```

### ✅ 已完成
```
✅ 您的報修已完成

報修編號：R20260224-001
感謝您的通報

如有任何問題，歡迎再次聯繫我們。
```

### ❌ 已取消
```
❌ 報修已取消

報修編號：R20260224-001
備註：重複報修
```

---

## 📊 資料表結構

### repair_requests（報修單）

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | SERIAL | 主鍵 |
| repair_number | VARCHAR(20) | 報修編號（R20260224-001）|
| user_id | VARCHAR(255) | LINE User ID |
| user_name | VARCHAR(255) | 使用者名稱 |
| repair_type | VARCHAR(50) | 類型（水電、電梯、公共設施、其他）|
| location | TEXT | 地點 |
| description | TEXT | 問題描述 |
| photo_url | TEXT | 照片 URL |
| status | VARCHAR(20) | 狀態（pending/processing/completed/cancelled）|
| priority | VARCHAR(20) | 優先級（low/normal/high/urgent）|
| assigned_to | VARCHAR(255) | 指派對象 |
| notes | TEXT | 備註 |
| created_at | TIMESTAMP | 建立時間 |
| updated_at | TIMESTAMP | 更新時間 |
| completed_at | TIMESTAMP | 完成時間 |

---

## 🔧 API 端點

### GET /api/repairs
查詢報修單列表

**參數：**
- `status` - 篩選狀態（pending/processing/completed/cancelled）
- `limit` - 限制筆數（預設：50）
- `offset` - 偏移量（預設：0）
- `id` - 查詢特定報修單

**範例：**
```bash
# 查詢所有待處理的報修單
GET /api/repairs?status=pending&limit=20
```

### PATCH /api/repairs
更新報修單狀態

**Body：**
```json
{
  "id": 1,
  "status": "processing",
  "priority": "high",
  "notes": "已派員處理"
}
```

### POST /api/repairs
管理員手動建立報修單

**Body：**
```json
{
  "user_id": "admin",
  "user_name": "管理員",
  "repair_type": "水電",
  "location": "3樓",
  "description": "水龍頭漏水",
  "priority": "normal"
}
```

### DELETE /api/repairs
刪除報修單

**參數：**
- `id` - 報修單 ID

---

## 🎨 狀態說明

| 狀態 | emoji | 說明 |
|------|-------|------|
| pending | 🟡 | 待處理（新建立的報修單）|
| processing | 🔵 | 處理中（管理員已開始處理）|
| completed | ✅ | 已完成（問題已解決）|
| cancelled | ❌ | 已取消（報修取消或重複）|

---

## 🚀 測試流程

### 1. 測試報修建立

在 LINE Bot 中：
1. 輸入「報修」
2. 選擇「💧 水電問題」
3. 輸入地點：「3樓電梯旁」
4. 輸入問題：「水龍頭漏水」
5. 輸入「略過」（不上傳照片）

預期結果：
- ✅ 收到確認訊息
- ✅ 顯示報修編號（R開頭）
- ✅ 狀態為「待處理」

### 2. 測試狀態更新與推播

在管理後台（或使用 API）：
1. 將狀態更新為「處理中」

預期結果：
- ✅ 住戶收到 LINE 推播通知
- ✅ 通知內容包含報修編號和狀態

### 3. 測試完成報修

在管理後台：
1. 將狀態更新為「已完成」

預期結果：
- ✅ 住戶收到完成通知
- ✅ completed_at 時間自動記錄
- ✅ 狀態變更記錄在 repair_status_history

---

## ⚠️ 注意事項

1. **報修編號生成**
   - 編號由資料庫自動生成，格式：R + 日期(YYYYMMDD) + 流水號(001)
   - 每日流水號從 001 重新開始

2. **推播通知**
   - 需要 LINE Channel Access Token 有 push message 權限
   - 推播失敗不會影響狀態更新

3. **照片處理**
   - 目前儲存 LINE Message ID，需要時可透過 LINE API 取得
   - 建議整合 Supabase Storage 或其他圖床服務

4. **權限管理**
   - 目前 RLS 設定為允許所有操作
   - 正式環境建議設定更嚴格的權限控制

---

## 📚 相關檔案

- `supabase_repair_tables.sql` - 資料表結構
- `app/api/line/route.js` - LINE Bot 報修流程處理
- `app/api/repairs/route.js` - 報修 API（含推播通知）
- `app/repairs/page.tsx` - 管理後台介面

---

## 🎉 完成！

現在你的 LINE Bot 已經具備完整的報修功能了！

有任何問題可以查看各檔案的註解說明。
