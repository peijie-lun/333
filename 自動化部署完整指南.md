# 🚀 自動化部署指南 - 零操作方案

## 🎯 目標
部署後**完全自動化**,不需要任何手動操作或額外程式碼。

---

## ✅ 最簡單方案 (推薦)

### 步驟 1: 使用 `app.js`

這個檔案已經整合了所有功能:
- ✅ 自動啟動 Supabase 監控
- ✅ 自動初始化快取
- ✅ 提供 API 端點
- ✅ 健康檢查
- ✅ 優雅關閉

**完全不需要改程式碼,直接部署即可!**

### 步驟 2: 確認 `.env` 設定

```env
SUPABASE_URL=你的_SUPABASE_URL
SUPABASE_ANON_KEY=你的_ANON_KEY
GROQ_API_KEY=你的_GROQ_KEY
GROQ_MODEL=llama-3.3-70b-versatile
PORT=3000
```

### 步驟 3: 啟動

本地測試:
```powershell
node app.js
```

看到這些訊息就成功了:
```
🚀 啟動應用程式...
📡 初始化 Supabase 自動同步...
[AutoSync] 初始化快取...
[AutoSync] knowledge 監聽已啟動
[AutoSync] images 監聽已啟動
✅ Supabase 即時同步已啟動
✅ 伺服器運行於 http://localhost:3000
📡 Supabase 資料會自動即時同步
💡 無需任何手動操作!
```

---

## 🌐 各平台部署方式

### 1️⃣ Heroku

#### package.json
確認有這行:
```json
{
  "scripts": {
    "start": "node app.js"
  }
}
```

#### Procfile
```
web: node app.js
```

#### 部署
```bash
git add .
git commit -m "Deploy with auto-sync"
git push heroku main
```

**Heroku 環境變數設定** (Dashboard → Settings → Config Vars):
- `SUPABASE_URL`
- `SUPABASE_ANON_KEY`
- `GROQ_API_KEY`
- `GROQ_MODEL`

✅ 部署完成!自動開始監控,無需任何操作!

---

### 2️⃣ Railway / Render

#### 設定檔案 (自動偵測)
Railway 和 Render 會自動偵測 `package.json` 的 `start` 腳本。

#### 環境變數
在平台 Dashboard 設定相同的環境變數。

#### 部署
連接 GitHub repo,自動部署。

✅ 完成!上線即監控!

---

### 3️⃣ AWS EC2 / VPS

#### 使用 PM2 管理
```bash
# 安裝 PM2
npm install -g pm2

# 啟動應用
pm2 start app.js --name my-app

# 開機自動啟動
pm2 startup
pm2 save

# 查看狀態
pm2 status
pm2 logs my-app
```

#### 設定環境變數
```bash
# 方法 1: 使用 .env 檔案
nano .env
# 貼上你的環境變數

# 方法 2: PM2 環境變數
pm2 start app.js --name my-app --env production
```

✅ 伺服器重開機也會自動啟動!

---

### 4️⃣ Docker

#### Dockerfile
```dockerfile
FROM node:18-slim

# 安裝 Python (用於 embedding)
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# 安裝 Python 套件
RUN pip3 install sentence-transformers

WORKDIR /app

# 安裝 Node 依賴
COPY package*.json ./
RUN npm install --production

# 複製程式碼
COPY . .

# 暴露端口
EXPOSE 3000

# 啟動
CMD ["node", "app.js"]
```

#### docker-compose.yml
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=llama-3.3-70b-versatile
    restart: unless-stopped
```

#### 部署
```bash
# 建立 .env 檔案
echo "SUPABASE_URL=你的URL" > .env
echo "SUPABASE_ANON_KEY=你的KEY" >> .env
echo "GROQ_API_KEY=你的KEY" >> .env

# 啟動
docker-compose up -d

# 查看日誌
docker-compose logs -f
```

✅ 容器自動重啟,監控持續運行!

---

### 5️⃣ Vercel (Serverless)

⚠️ Vercel 是 Serverless,每次請求都是新環境,**不適合**持續監控。

#### 替代方案: 使用 Vercel Cron
```javascript
// api/cron/sync.js
export default async function handler(req, res) {
  const { forceUpdate } = require('../../supabase_auto_sync');
  await forceUpdate();
  res.json({ success: true });
}
```

#### vercel.json
```json
{
  "crons": [{
    "path": "/api/cron/sync",
    "schedule": "*/10 * * * *"
  }]
}
```

每 10 分鐘自動更新一次快取。

---

## ⚙️ Supabase 設定 (一次性)

### 🔴 重要!啟用 Realtime

1. 登入 [Supabase Dashboard](https://app.supabase.com)
2. 選擇專案 → **Database** → **Replication**
3. 找到資料表並啟用 Realtime:
   - ✅ `knowledge` 
   - ✅ `images`

### SQL 設定 (可選)
```sql
-- 確保資料表支援 Realtime
ALTER TABLE knowledge REPLICA IDENTITY FULL;
ALTER TABLE images REPLICA IDENTITY FULL;
```

---

## 🎯 運作流程

```
應用程式啟動
      ↓
自動初始化快取 (如果不存在)
      ↓
啟動 WebSocket 監聽
      ↓
────────────────────────────
|  背景持續運行         |
|  監控 Supabase 變更   |
────────────────────────────
      ↓
資料變更時自動更新快取
      ↓
API 永遠使用最新資料
```

**完全自動化!** 🎉

---

## 📊 監控與驗證

### 檢查同步狀態
```bash
curl http://your-domain.com/health
```

回應:
```json
{
  "status": "ok",
  "syncActive": true,
  "timestamp": "2025-11-17T10:30:00.000Z"
}
```

### 測試即時更新
1. 在 Supabase Dashboard 新增一筆資料
2. 觀察伺服器日誌,應該會看到:
   ```
   [AutoSync] 快取已更新: id=1
   ```
3. 呼叫你的 API,會立即使用新資料

### 查看日誌
```bash
# PM2
pm2 logs my-app

# Docker
docker-compose logs -f

# Heroku
heroku logs --tail --app your-app-name
```

---

## 🔧 整合到現有專案

如果你已經有一個 server.js 或 index.js:

```javascript
// 在你的主檔案開頭加入這幾行
const { startAutoSync } = require('./supabase_auto_sync');

async function startServer() {
  // 啟動自動同步
  await startAutoSync();  // 就這一行!
  
  // 你原本的伺服器啟動程式碼
  app.listen(3000, () => {
    console.log('Server started');
  });
}

startServer();
```

**只需要加 1 行程式碼!** ✨

---

## 🆚 方案比較

| 方案 | 優點 | 缺點 | 適合場景 |
|------|------|------|---------|
| **即時監控** (推薦) | 資料立即同步<br>零延遲 | 需要持續連線 | 長期運行的伺服器<br>Heroku/VPS/Docker |
| **定時更新** | 簡單<br>Serverless 友善 | 有延遲(10分鐘) | Vercel/Lambda |
| **手動觸發** | 完全可控 | 需要人工操作 | 開發測試 |

---

## ✅ 檢查清單

部署前確認:

- [ ] `.env` 所有變數已設定
- [ ] Supabase Realtime 已啟用
- [ ] Python 和 sentence-transformers 已安裝
- [ ] `package.json` 的 `start` 腳本正確
- [ ] 測試過本地運行正常
- [ ] 環境變數已設定到部署平台

---

## 🎉 總結

### 最簡單的使用方式:

1. **部署 `app.js`**
2. **設定環境變數**
3. **啟用 Supabase Realtime**

**就這樣!** 🚀

上線後:
- ✅ 自動監控資料變更
- ✅ 自動更新快取
- ✅ API 永遠使用最新資料
- ✅ 完全無需手動操作

**真正的零維護方案!** 🎊
